name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual deployment

env:
  DEPLOY_USER: deploy
  DEPLOY_PATH: /opt/cronny
  ENVIRONMENT: production

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run Go tests
        working-directory: ./core
        run: |
          go mod download
          go test ./... -v

      - name: Run Frontend tests
        working-directory: ./cronui
        run: |
          npm ci
          npm test -- --passWithNoTests

      - name: Build Docker images (test)
        run: |
          docker build -f build/Dockerfile.api -t cronnyapi:test .
          docker build -f build/Dockerfile.frontend -t cronnyfrontend:test .
          docker build -f build/Dockerfile.triggercreator -t cronnytriggercreator:test .
          docker build -f build/Dockerfile.triggerexecutor -t cronnytriggerexecutor:test .

  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Check server connection
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ secrets.DROPLET_IP }} "echo 'Server connection successful'"

      - name: Deploy application
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ secrets.DROPLET_IP }} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "Pulling latest changes..."
            git fetch origin
            git checkout main
            git pull origin main

            echo "Running deployment script..."
            cd deploy/scripts
            CRONNY_ENV=${{ env.ENVIRONMENT }} ./deploy.sh
          ENDSSH

      - name: Health check
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30

          # Check API health
          echo "Checking API health..."
          for i in {1..10}; do
            if curl -f -k https://${{ secrets.DOMAIN_NAME }}/api/health; then
              echo "API is healthy"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "API health check failed after 10 attempts"
              exit 1
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          # Check frontend
          echo "Checking frontend..."
          if curl -f -k https://${{ secrets.DOMAIN_NAME }}; then
            echo "Frontend is accessible"
          else
            echo "Frontend check failed"
            exit 1
          fi

      - name: Verify deployment
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ secrets.DROPLET_IP }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}/deploy/docker
            docker compose -f docker-compose.prod.yml ps
            docker compose -f docker-compose.prod.yml logs --tail=50
          ENDSSH

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to production successful!"
            echo "Commit: ${{ github.sha }}"
            echo "URL: https://${{ secrets.DOMAIN_NAME }}"
          else
            echo "âŒ Deployment failed!"
            echo "Please check the logs and consider rolling back."
          fi

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Rollback to previous version
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ secrets.DROPLET_IP }} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "Rolling back to previous commit..."
            cd deploy/scripts
            CRONNY_ENV=${{ env.ENVIRONMENT }} ./rollback.sh -p
          ENDSSH

      - name: Verify rollback
        run: |
          echo "Waiting for rollback to complete..."
          sleep 30

          if curl -f -k https://${{ secrets.DOMAIN_NAME }}/api/health; then
            echo "âœ… Rollback successful - API is healthy"
          else
            echo "âŒ Rollback verification failed - manual intervention required!"
            exit 1
          fi

      - name: Rollback notification
        run: |
          echo "ðŸ”„ Automatic rollback completed due to deployment failure"
          echo "Previous commit has been restored"
          echo "Please investigate the failed deployment before trying again"
